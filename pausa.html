<!DOCTYPE html>
<html>
<head>
	<meta charset="UTF-8">
	<meta name=”viewport” content=”width=device-width, initial-scale=1″>
	<script type="text/javascript" src="plugin/jQuery/jquery-2.1.4.min.js"></script>
	<link rel="stylesheet" type="text/css" href="plugin/css/all.css">
	<link rel="stylesheet" type="text/css" href="plugin/bootstrap43/css/bootstrap.min.css"/>
	<link rel="stylesheet" type="text/css" href="plugin/css/style.css">
	<title>Bullseye</title>
	<script type="text/javascript" src="plugin/bootstrap43/js/bootstrap.min.js"></script>
	<script type="text/javascript" src="plugin/three/three.js"></script>
	<script type="text/javascript" src="plugin/three/MTLLoader.js"></script>
	<script type="text/javascript" src="plugin/three/OBJLoader.js"></script>
	<script type="text/javascript" src="plugin/three/FBXLoader.js"></script>
	<script type="module" src="plugin/three/LoaderUtils.js"></script>

	<script type="text/javascript">
					
		var max = 0;
		var max2 = 0;
		var bol = false;
		var positioncub1=0;
		
		var isPlay=true;
		var isPause=false;

		var scene;

		var renderer;

		var camera;
		var controls;
		var objects = [];
		var clock;
		var deltaTime;	
		var keys = {};
		var char1= new THREE.Object3D();
		var raycast;
		var modelC = new THREE.Object3D();
		var objetosConColision = [];
		var isWorldReady = [ false];
		var objs = [];
		
		$(document).ready(function() {
			setupScene();
			//alert("Para activar el menu de pausa debe presionarse la tecla espacio en el teclado");
			raycast = new THREE.Raycaster();
			

			 
			/*Eventos Menus*/

			/*Pausas Eventos*/
			$('#reanudarJuego').click(function(){
			$('#modalLogIn').modal('hide'); 
			isPlay=true;
			isPause=false;
			
			});
			$('#pauseClose').click(function(){
			$('#modalLogIn').modal('hide'); 
			isPlay=true;
			isPause=false;
			
			});
			/*Fin Pausas Eventos*/


			/*Configuracion Eventos*/
			$('#confModal').click(function(){
				$('#modalLogIn').modal('hide'); 
				$('#modalConfig').modal('show');
			});
			$('#backConfigToPause').click(function(){
				$('#modalConfig').modal('hide');
				$('#modalLogIn').modal('show');

			});
			$('#confClose').click(function(){
				$('#modalConfig').modal('hide');
				$('#modalLogIn').modal('show');

			});
			/*Fin Configuracion Eventos*/

			/*Puntuaciones Eventos*/
			$('#rankModal').click(function(){
				$('#modalLogIn').modal('hide'); 
				$('#modalRanking').modal('show');
			});
			$('#backRankingToPause').click(function(){
				$('#modalRanking').modal('hide');
				$('#modalLogIn').modal('show');

			});
			$('#rankingClose').click(function(){
				$('#modalRanking').modal('hide');
				$('#modalLogIn').modal('show');

			});
			/*Fin Puntuaciones Eventos*/

			/*Controles Eventos*/
			$('#contModal').click(function(){
				$('#modalLogIn').modal('hide'); 
				$('#modalControls').modal('show');
			});
			$('#backControlsToPause').click(function(){
				$('#modalControls').modal('hide');
				$('#modalLogIn').modal('show');

			});
			$('#contClose').click(function(){
				$('#modalControls').modal('hide');
				$('#modalLogIn').modal('show');

			});
			/*Fin Controles Eventos*/

			/*Fin Eventos de Menus*/
			
			
			loadOBJWithMTL(
			"assets/",
			"floor1.obj",
			"floor1.mtl",
			(objeto3D) => {
				// Objeto cargado y listo para ser manipulado.
				scene.add(objeto3D);
				objetosConColision.push(objeto3D);
				//isWorldReady[0]=true;
				
				
			}
		);
						loadOBJWithMTL(
			"assets/",
			"Pj1.obj",
			"Pj1.mtl",
			(objeto3D) => {
				objeto3D.position.y=3.5;
				objeto3D.rotation.y=Math.PI / 2;
				char1=objeto3D.clone();
					
				
				scene.add(char1);
				objetosConColision.push(char1);
				
				
			}
		);
						/*loadOBJWithMTL(
			"assets/",
			"Boss.obj",
			"Boss.mtl",
			(boss) => {
				scene.add(boss);
				boss.name='jefe';
				objetosConColision.push(boss);
				isWorldReady[2] = true;
			}
		);

						loadOBJWithMTL(
			"assets/",
			"AlienPlant.obj",
			"AlienPlant.mtl",
			(enemy) => {
				scene.add(enemy);
				enemy.name='enemigo';
				objetosConColision.push(enemy);
				
			}
		);
*/
						
		/*var loader = new THREE.FBXLoader();
		loader.load("xsi_man_skinning.fbx ", function (object){

			mixer = new THREE.AnimationMixer(object);

			object.scale.x = 0.05;
			object.scale.y = 0.05;
			object.scale.z = 0.05;
			
			var action = mixer.clipAction( object.animations[ 0 ]);
			action.timeScale = 500
			action.play();
			scene.add(object);
			//objs.push({object, mixer});
			object.name = "chibiAnm";
		});
*/
		
    	const loader = new THREE.FBXLoader();
    	loader.load("assets/Death.fbx", model => {
        	// model is a THREE.Group (THREE.Object3D)  

        	const mixer = new THREE.AnimationMixer(model);

        	/*model.scale.x = 0.05;
        	model.scale.y = 0.05;
        	model.scale.z = 0.05;*/
        	// animations is a list of THREE.AnimationClip                          
        	mixer.clipAction(model.animations[0]).play();
        	scene.add(model);
			objs.push({model, mixer});
			action.timeScale = 50;

			model.name = "chibiAnm";

		});

		render();

		document.addEventListener('keydown', onKeyDown);
		document.addEventListener('keyup', onKeyUp);		
			document.getElementById("goToIndex").onclick = function() {exitGame()};

		function exitGame(){
			var r=confirm("¿Deseas salir del juego?");

			if(r==true)
			{
				window.location.href = 'index.html';
			}
			else{

			}
		};
		});

		function loadOBJWithMTL(path, objFile, mtlFile, onLoadCallback) {
		
		var mtlLoader = new THREE.MTLLoader();
		mtlLoader.setPath( path );
		mtlLoader.load( mtlFile, (material) =>{
			// Entra solo cuando termine de cargar el material.

			var objLoader = new THREE.OBJLoader();
			objLoader.setPath( path );
			objLoader.setMaterials(material);
			objLoader.load(objFile, (objeto3D) =>{
				// Entra solo cuando termine de cargar el obj.

				onLoadCallback(objeto3D);


			});
		});



	}

	function onKeyDown(event) {
		keys[String.fromCharCode(event.keyCode)] = true;
	}
	function onKeyUp(event) {
		keys[String.fromCharCode(event.keyCode)] = false;
	}

			

		
		document.addEventListener("keydown", onDocumentKeyDown, false);
		function onDocumentKeyDown(event) {
		    var keyCode = event.which;
		    if (keyCode == 32) {
		    	if(isPause==false){
		    	isPlay=false;
		    	isPause=true;
		       	$('#modalLogIn').modal('show'); 
				}
			}
		     	
		};
	
		function render() {
		requestAnimationFrame(render);
		deltaTime = clock.getDelta();	

		objs.forEach(({mixer}) => {mixer.update(deltaTime);});
		
		var char2=scene.getObjectByName('jugador2');
		

		var yaw = 0;
		var forward = 0;
			if(isPlay==true){
				if (keys["A"]) {
			yaw = -3;
			char1.position.x-=(3 *deltaTime);
		} else if (keys["D"]) {
			yaw = 3;
			char1.position.x+=(3 *deltaTime);
		}
		if (keys["W"]) {
			forward = 1;
			char1.position.y+=(1 *deltaTime);
		} else if (keys["S"]) {
			forward = -1;
			char1.position.y-=(1 *deltaTime);
		}

		if (keys["J"]) {
			
			char2.position.x-=(3 *deltaTime);
		} else if (keys["L"]) {
			
			char2.position.x+=(3 *deltaTime);
		}
		if (keys["I"]) {
			
			char2.position.y+=(1 *deltaTime);
		} else if (keys["K"]) {
			
			char2.position.y-=(1 *deltaTime);
		}
			}
		
		modelC.misRayos = [
			new THREE.Vector3(1, 0, 0),
			new THREE.Vector3(-1, 0, 0),
			new THREE.Vector3(0, 0, 1),
			new THREE.Vector3(0, 0, -1)
		];
			camera.translateY(forward * deltaTime);
			
			//camera.rotation.y += yaw * deltaTime;
			

			for(var i = 0; i < modelC.misRayos.length; i ++){

				var rayo = modelC.misRayos[i];
				
				raycast.set( char1.position, rayo);

				var colisiones = raycast.intersectObjects(objetosConColision, true);

				if(colisiones.length > 0){

					if(colisiones[0].distance < 3){
						
						char1.position.y+=(1 *deltaTime);
						console.log("colisionando");
					}					
				}

			}



		

		renderer.render(scene, camera);
	}
	function setupScene() {		
		var visibleSize = { width: window.innerWidth, height: window.innerHeight};
		
		clock = new THREE.Clock();		
		scene = new THREE.Scene();
		camera = new THREE.PerspectiveCamera(75, visibleSize.width / visibleSize.height, 0.1, 100);
		camera.position.z = 8;
		camera.position.y = 5;
		camera.position.x = -1;

		renderer = new THREE.WebGLRenderer( {precision: "mediump" } );
		renderer.setClearColor(new THREE.Color(0, 0, 0));
		renderer.setPixelRatio(visibleSize.width / visibleSize.height);
		renderer.setSize(visibleSize.width, visibleSize.height);

		// Background
            var path = "assets/cubemap/";
            var urls = [
                path + "px.jpg", path + "nx.jpg",
                path + "py.jpg", path + "ny.jpg",
                path + "pz.jpg", path + "nz.jpg"
            ];
            var textureCube = new THREE.CubeTextureLoader().load( urls );
            textureCube.mapping = THREE.CubeRefractionMapping;
            scene.background = textureCube;

		var ambientLight = new THREE.AmbientLight(new THREE.Color(1, 1, 1), 1.0);
		scene.add(ambientLight);

		var directionalLight = new THREE.DirectionalLight(new THREE.Color(1, 1, 1), 0.4);
		directionalLight.position.set(0, 0, 1);
		scene.add(directionalLight);

		
		

		$("#scene-section").append(renderer.domElement);
	}
	</script>
</head>
<body>
		<div id="scene-section"/>
	
	<!-- Menu modal -->
	<!-- Menu de pausa -->
	<div class="modal fade" id="modalLogIn" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true" data-keyboard="false">
	  <div class="modal-dialog" role="document">
	    <div class="modal-content">
	      <div class="modal-header">
	        <h3 class="modal-title" id="exampleModalLabel">Pausa</h3>
	        <button type="button" class="close" data-dismiss="modal" id="pauseClose" aria-label="Close">
	          <span aria-hidden="true"  id="xClose">&times;</span>
	        </button>
	      </div>
	      <div class="modal-body">
	        	<form>
	        		<a href="#" class="btn btn-success btn-block ini" id="reanudarJuego"><i class="fas fa-user"></i> Reanudar juego</a><br>
					<a href="#" class="btn btn-warning btn-block ini" id="contModal" ><i class="fas fa-gamepad"></i> Controles</a><br>
					<a href="#" class="btn btn-warning btn-block ini" id="rankModal" ><i class="fas fa-trophy"></i> Puntuaciones</a><br>
					<a href="#" class="btn btn-warning btn-block ini" id="confModal"><i class="fas fa-cog"></i> Configuracion</a><br>
					<a href="#" class="btn btn-danger btn-block ini" id="goToIndex"><i class="fas fa-sign-out-alt"></i> Salir</a><br>
                </form>           
	      </div>
	    </div>
	  </div>
	</div>
	<!-- fin menu de pausa -->

	<!-- Menu Controles -->
	<div class="modal fade" id="modalControls" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true" data-keyboard="false">
	  <div class="modal-dialog" role="document">
	    <div class="modal-content" id="controlCard">
	      <div class="modal-header">
	        <h3 class="modal-title" id="exampleModalLabel">Controles</h3>
	        <button type="button" class="close" data-dismiss="modal" id="contClose" aria-label="Close">
	          <span aria-hidden="true"  id="xClose">&times;</span>
	        </button>
	      </div>
	      <div class="modal-body">
	        	<form>
	        		<a href="#" class="btn btn-warning btn-block ini" id="backControlsToPause"><i class="fas fa-backspace"></i> Regresar</a><br>
						<ul class="list-group">
						  <li class="list-group-item" id="titleControl"><i class="fas fa-keyboard"></i> Jugador 1</li>
						  <li class="list-group-item"><i class="fas fa-arrow-right"></i></i> D </li>
						  <li class="list-group-item"><i class="fas fa-arrow-left"></i> A </li>
						  <li class="list-group-item"><i class="fas fa-arrow-up"></i></i> W </li>
						  <li class="list-group-item"><i class="fas fa-arrow-down"></i> S </a>
						  <li class="list-group-item" id="titleControl"><i class="fas fa-gamepad"></i></i> Jugador 2</li>
						  <li class="list-group-item"><i class="fas fa-caret-square-right"></i></i> L </li>
						  <li class="list-group-item"><i class="fas fa-caret-square-left"></i></i> J </li>
						  <li class="list-group-item"><i class="fas fa-caret-square-up"></i></i> I </li>
						  <li class="list-group-item"><i class="fas fa-caret-square-down"></i></i> K </a>
						</ul class="dropdown-menu" role="menu">
                </form>           
	      </div>
	    </div>
	  </div>
	</div>
	<!-- Fin Menu Controles -->

	<!-- Menu Puntuaciones -->
	<div class="modal fade" id="modalRanking" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true" data-keyboard="false">
	  <div class="modal-dialog" role="document">
	    <div class="modal-content">
	      <div class="modal-header">
	        <h3 class="modal-title" id="exampleModalLabel">Puntuaciones</h3>
	        <button type="button" class="close" data-dismiss="modal" id="rankingClose" aria-label="Close">
	          <span aria-hidden="true"  id="xClose">&times;</span>
	        </button>
	      </div>
	      <div class="modal-body">
	        	<form>
	        		<a href="#" class="btn btn-warning btn-block ini" id="backRankingToPause"><i class="fas fa-backspace"></i> Regresar</a><br>
						<div class="container2">
						  <h2 class="h2score"><i class="fas fa-crown"></i> Ranking</h2>
						  <table class="table table table-dark table-striped">
						    <thead>
						      <tr>
						        <th>Nombre</th>
						        <th>Score</th>
						        <th>Compartir</th>
						      </tr>
						    </thead>
						    <tbody>
						      <tr>
						        <td>John</td>
						        <td>2562</td>
						        <td class="compartir">
						        	<a class="iconsshare" href="https://www.facebook.com/"><i class="fab fa-facebook fa-lg"></i></a>
									<a class="iconsshare" href="https://www.twitter.com/"><i class="fab fa-twitter-square fa-lg"></i></a>
						        </td>
						      </tr>
						      <tr>
						        <td>Mary</td>
						        <td>654</td>
						       	<td class="compartir">
						       		<a class="iconsshare" href="https://www.facebook.com/"><i class="fab fa-facebook fa-lg"></i></a>
									<a class="iconsshare" href="https://www.twitter.com/"><i class="fab fa-twitter-square fa-lg"></i></a>
						        </td>
						      </tr>
						      <tr>
						        <td>July</td>
						        <td>456</td>
						        <td class="compartir">
						        	<a class="iconsshare" href="https://www.facebook.com/"><i class="fab fa-facebook fa-lg"></i></a>
									<a class="iconsshare" href="https://www.twitter.com/"><i class="fab fa-twitter-square fa-lg"></i></a>
						        </td>
						      </tr>
						    </tbody>
						  </table>
						</div>
                </form>           
	      </div>
	    </div>
	  </div>
	</div>
	<!-- Fin Menu Puntuaciones -->

	<!-- Menu Configuracion -->
	<div class="modal fade" id="modalConfig" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true" data-keyboard="false">
	  <div class="modal-dialog" role="document">
	    <div class="modal-content">
	      <div class="modal-header">
	        <h3 class="modal-title" id="exampleModalLabel">Configuracion</h3>
	        <button type="button" class="close" data-dismiss="modal" id="confClose" aria-label="Close">
	          <span aria-hidden="true"  id="xClose">&times;</span>
	        </button>
	      </div>
	      <div class="modal-body">
	        	<form>
	        		<a href="#" class="btn btn-warning btn-block ini" id="backConfigToPause"><i class="fas fa-backspace"></i> Regresar</a><br>
						<ul class="list-group">
						  <li class="list-group-item" id="titleControl"></i> Titulo por asignar</li>
						  <li class="list-group-item" id="titleControl"></i> Titulo por asignar</li>
						  <li class="list-group-item" id="titleControl"></i> Titulo por asignar</li>
						  <li class="list-group-item" id="titleControl"></i> Titulo por asignar</li>						  
						</ul class="dropdown-menu" role="menu">
                </form>           
	      </div>
	    </div>
	  </div>
	</div>
	<!-- Fin Menu Configuracion -->
	
	<!-- fin menu modal -->

</body>
</html>